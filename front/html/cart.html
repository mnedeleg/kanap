<!DOCTYPE html>
<html lang="fr">
  <head>
    <title>Cart</title>

    <meta charset="utf-8">
    <meta name="description" content="Plateforme incroyable de e-commerce">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet" />
    <link href="../css/cart.css" rel="stylesheet" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>

  <body>
    <header>
      <div class="limitedWidthBlockContainer informations">
        <div class="limitedWidthBlock">
          <ul>
            <li><img src="../images/icons/phone.svg" alt="logo de téléphone" class="informations__phone">01 23 45 67 89</li>
            <li><img src="../images/icons/mail.svg" alt="logo d'une enveloppe" class="informations__mail">support@name.com</li>
            <li><img src="../images/icons/adress.svg" alt="logo d'un point de géolocalisation" class="informations__address">01 23 45 67 89</li>
          </ul>
        </div>
      </div>
      <div class="limitedWidthBlockContainer menu">
        <div class="limitedWidthBlock">
          <a href="./index.html">
            <img class="logo" src="../images/logo.png" alt="Logo de l'entreprise">
          </a>
          <nav>
            <ul>
              <a href="./index.html"><li>Accueil</li></a>
              <a href="./cart.html"><li>Panier</li></a>
            </ul>
          </nav>
        </div>
      </div>
      <img class="banniere" src="../images/banniere.png" alt="Baniere">
    </header>
    
    <main class="limitedWidthBlockContainer">
      <div class="limitedWidthBlock" id="limitedWidthBlock">
        <div class="cartAndFormContainer" id="cartAndFormContainer">
          <h1>Votre panier</h1>
          <section class="cart">
            <section id="cart__items">
              <!-- <article class="cart__item" data-id="{product-ID}" data-color="{product-color}">
                <div class="cart__item__img">
                  <img src="../images/product01.jpg" alt="Photographie d'un canapé">
                </div>
                <div class="cart__item__content">
                  <div class="cart__item__content__description">
                    <h2>Nom du produit</h2>
                    <p>Vert</p>
                    <p>42,00 €</p>
                  </div>
                  <div class="cart__item__content__settings">
                    <div class="cart__item__content__settings__quantity">
                      <p>Qté : </p>
                      <input type="number" class="itemQuantity" name="itemQuantity" min="1" max="100" value="42">
                    </div>
                    <div class="cart__item__content__settings__delete">
                      <p class="deleteItem">Supprimer</p>
                    </div>
                  </div>
                </div>
              </article> -->
            </section>
            <div class="cart__price">
              <p>Total (<span id="totalQuantity"><!-- 2 --></span> articles) : <span id="totalPrice"><!-- 84,00 --></span> €</p>
            </div>
            <div class="cart__order">
              <form method="get" class="cart__order__form">
                <div class="cart__order__form__question">
                  <label for="firstName">Prénom: </label>
                  <input type="text" name="firstName" id="firstName" required>
                  <p id="firstNameErrorMsg"><!-- ci est un message d'erreur --></p>
                </div>
                <div class="cart__order__form__question">
                  <label for="lastName">Nom: </label>
                  <input type="text" name="lastName" id="lastName" required>
                  <p id="lastNameErrorMsg"></p>
                </div>
                <div class="cart__order__form__question">
                  <label for="address">Adresse: </label>
                  <input type="text" name="address" id="address" required>
                  <p id="addressErrorMsg"></p>
                </div>
                <div class="cart__order__form__question">
                  <label for="city">Ville: </label>
                  <input type="text" name="city" id="city" required>
                  <p id="cityErrorMsg"></p>
                </div>
                <div class="cart__order__form__question">
                  <label for="email">Email: </label>
                  <input type="email" name="email" id="email" required>
                  <p id="emailErrorMsg"></p>
                </div>
                <div class="cart__order__form__submit">
                  <input type="submit" value="Commander !" id="order">
                </div>
              </form>
            </div>
          </section>
        </div>
      </div>
    </main>
    
    <footer>
      <div class="limitedWidthBlockContainer footerMain">
        <div class="limitedWidthBlock">
          <div>
            <img class="logo" src="../images/logo.png" alt="Logo de l'entreprise">
          </div>
          <div>
            <p>10 quai de la charente <br>75019 Paris 19</p>
          </div>
          <div>
            <p>Téléphone : 01 23 45 67 89</p>
          </div>
          <div>
            <p>Email : support@name.com</p>
          </div>
        </div>
      </div>
      <div class="limitedWidthBlockContainer footerSecondary">
        <div class="limitedWidthBlock">
          <p>© Copyright 2021 - 2042 | Openclassrooms by Openclassrooms | All Rights Reserved | Powered by <3</p>
        </div>
      </div>
    </footer>
  <script src="../js/cart.js"></script>
  <script>

    // Faire un fetch via local storage (getItem) pour récupérer le tableau (des éléments préalablement ajoutés) V
    // Parcourir le tableau avec une boucle qui charge les éléments du LS
    // Faire un fetch pour récuprérer les id des prodduits
    // Faire des "document.create" pour visualiser le panier ?

let basket = JSON.parse(localStorage.getItem("basket"))
if (basket != undefined) { // === nul ??

  const cartItems = document.getElementById("cart__items");
  let totalPrice = 0;
  let totalQuantity = 0;
    for (let i = 0; i < basket.length; i++) {
      const element = basket[i];
    

  
      fetch("http://localhost:3000/api/products/" + element.id)
        .then(res => res.json())
        .then(productLs => {

          let sousTotal = element.quantity * parseFloat(productLs.price);
          totalPrice += sousTotal;
          document.getElementById("totalPrice").textContent = totalPrice;

          let sousTotalQuantity = element.quantity;
          totalQuantity += sousTotalQuantity;
          document.getElementById("totalQuantity").textContent = totalQuantity;
    

          let article = document.createElement("article");
          article.setAttribute("class", "cart__item" );
          article.setAttribute("data-id", element.id);
          article.setAttribute("data-color", element.color);

          let cartItemImg = document.createElement("div");
          cartItemImg.setAttribute("class", "cart__item__img" );
          article.appendChild(cartItemImg);

          let productImg = document.createElement("img");
          productImg.setAttribute("src", productLs.imageUrl);
          productImg.setAttribute("alt", productLs.altTxt);
          cartItemImg.appendChild(productImg);
          
          let cartItemContent = document.createElement("div");
          cartItemContent.setAttribute("class", "cart__item__content");
          article.appendChild(cartItemContent);

          let cartItemContentDescription = document.createElement("div");
          cartItemContentDescription.setAttribute("class", "cart__item__content__description");
          cartItemContent.appendChild(cartItemContentDescription);

          let productName = document.createElement("h2");
          productName.textContent = productLs.name;
          cartItemContentDescription.appendChild(productName);

          let productColor = document.createElement("p");
          productColor.textContent = element.color;
          cartItemContentDescription.appendChild(productColor);

          let productPrice = document.createElement("p");
          productPrice.textContent = productLs.price;
          cartItemContentDescription.appendChild(productPrice);

          let cartItemContentSettings = document.createElement("div");
          cartItemContentSettings.setAttribute("class", "cart__item__content__settings");
          cartItemContent.appendChild(cartItemContentSettings);

          let cartItemSettingsQuantity = document.createElement("div");
          cartItemSettingsQuantity.setAttribute("class", "cart__item__content__settings__quantity");
          cartItemContentSettings.appendChild(cartItemSettingsQuantity);

          let quantityLabel =  document.createElement("p");
          quantityLabel.textContent = "Qté : ";
          cartItemSettingsQuantity.appendChild(quantityLabel);


          let quantityInput = document.createElement("input");
          quantityInput.setAttribute("type", "number");
          quantityInput.setAttribute("name", "itemQuantity");
          quantityInput.setAttribute("class", "itemQuantity");
          quantityInput.setAttribute("min", "1");
          quantityInput.setAttribute("max", "100");
          quantityInput.setAttribute("value", element.quantity);
          quantityInput.setAttribute("data-id", element.id);
          quantityInput.setAttribute("data-color", element.color);
          
          cartItemSettingsQuantity.appendChild(quantityInput);

          let cartItemSettingsDelete = document.createElement("div");
          cartItemSettingsDelete.setAttribute("class", "cart__item__content__settings__delete");
          cartItemContentSettings.appendChild(cartItemSettingsDelete);

          let deleteLabel = document.createElement("p");
          deleteLabel.setAttribute("class", "deleteItem");
          deleteLabel.textContent = "Supprimer";
          deleteLabel.setAttribute("value", element.quantity);
          deleteLabel.setAttribute("data-id", element.id);
          deleteLabel.setAttribute("data-color", element.color);
          cartItemSettingsDelete.appendChild(deleteLabel);

          cartItems.appendChild(article);
          
        })
      }
  
     
}else{
  console.log("Le panier est vide")
}

      //////// Removing Item from the cart ////////
      // Add an event listener on "supprimer" (class : deletedItem) on click

function saveBasket(basket){
  localStorage.setItem("basket",JSON.stringify(basket)); 
  }
    
function removeItem(cartItem){
  let basket = JSON.parse(localStorage.getItem("basket"))
  basket = basket.filter(p => (p.id != cartItem.id || p.id == cartItem.id)  && p.color != cartItem.color);
  
  saveBasket(basket);
  window.location.reload();
}


// change quantity //

function changeQuantity(element, qtt){
  let basket = JSON.parse(localStorage.getItem("basket"))
  let foundProduct = basket.find(p => p.id == element.id && element.color == p.color);
  console.log(foundProduct);
  if (foundProduct != undefined){
    foundProduct.quantity = parseInt(qtt);
    saveBasket(basket);
  } 

}
window.onload = function() {
  
  let deletedArticle = document.querySelectorAll(".deleteItem");
  console.log(deletedArticle);
  deletedArticle.forEach(deleteBtn => {
    deleteBtn.addEventListener('click', (e) => {
    let id = e.target.getAttribute("data-id");
    let color = e.target.getAttribute("data-color");
    let cartItem = {id, color};
    console.log("basket");
    removeItem(cartItem);
   
    })
  })
 

  let changeQuantityItem = document.querySelectorAll(".itemQuantity");
  changeQuantityItem.forEach(quantityArrow => {
    quantityArrow.addEventListener('click', (e) => {
    
    let id = e.target.getAttribute("data-id");
    let color = e.target.getAttribute("data-color");
    let item = {id, color};
    let qtt = e.target.value
   

    
     changeQuantity(item, qtt);
    //  SaveBasket(basket);
    })
  })
}

let form = document.querySelector('.cart__order__form');
console.log(form.firstName);

////// prénom/////

form.firstName.addEventListener('change', function(){
  validFirstName(this);
});

const validFirstName = function(inputFirstName){
  //création de la regExp pour validation email
  let firstNameRegExp = new RegExp (
  '^[a-zA-Z-]{2,20}$', 'g'

  );

  let testFirstName = firstNameRegExp.test(inputFirstName.value);
  console.log(testFirstName)
  let errorMessFirstName = inputFirstName.nextElementSibling;

    if(testFirstName == true){
      
    }else{
      errorMessFirstName.textContent = 'Prénom non valide';
    }
      
  };

  ////// nom /////

form.lastName.addEventListener('change', function(){
  validLastName(this);
});

const validLastName = function(inputLastName){
  //création de la regExp pour validation email
  let lastNameRegExp = new RegExp (
  '^[a-zA-Z-]{2,40}$', 'g'

  );

  let testLastName = LastNameRegExp.test(inputLastName.value);
  console.log(testLastName)
  let errorMessLastName = inputLastName.nextElementSibling;

    if(testLastName == true){
      
    }else{
      errorMessLastName.textContent = 'Nom non valide';
    }
      
  };
////// Email /////
form.email.addEventListener('change', function(){
  validEmail(this);
});

const validEmail = function(inputEmail){
  //création de la regExp pour validation email
  let emailRegExp = new RegExp (
  '^[a-zA-Z0-9.-_]+[@]{1}[a-zA-Z0-9.-_]+[.]{1}[a-z]{2,10}$', 'g'
  //^ensemble de caractère de a à z + maj ok + nombre 0 à 9 et des points et des underscores et des tirets
  //"+" on peut en écrire plusieurs - fin des premiers crochets = première partie email
  //@ à retrouver/ combien de fois ? 1 fois
  //on recommence...caractères nombre etc...
  // le point et qu'un seul
  //a-z en minuscule et deux lettres min et 10max
  //un marqueur : soit un deuxième paramètres (ou flag) : comment lire ce regExp
  //'g' lecture de manière global
  );

  let testEmail = emailRegExp.test(inputEmail.value);
  console.log(testEmail)
  let errorMess = inputEmail.nextElementSibling;

    if(testEmail == true){
      
    }else{
      errorMess.textContent = 'Adresse mail non valide';
    }
      
  };


    


  </script>
  </body>
</html>